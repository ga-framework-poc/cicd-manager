name: 'onboard-system'
on:
  workflow_dispatch:
    inputs:
      system-name:
        description: 'system-name: Name of the system to be onboarded and managed by the CICD system'
        required: true
jobs:
  gather-system-info:
    runs-on: build.mdw.nicks.world
    steps:
    - id: setup-environment
      name: setup-environment
      run: |
        set -x
        echo "SYSTEM_NAME=${{ github.event.inputs.system-name }}" >> ${GITHUB_ENV}
        echo "CICD_REPO_MGR_DIR=${GITHUB_WORKSPACE}/${GITHUB_REPOSITORY}" >> ${GITHUB_ENV}
        echo "SYSTEM_DEFS_DIR=${GITHUB_WORKSPACE}/${GITHUB_REPOSITORY}/.github/system-defs" >> ${GITHUB_ENV}
        set +x

        echo ::set-output name=secret-token::$(cat /var/secrets/PAT_TOKEN) 
    - id: clone-cicd-manager-repo
      name: clone-cicd-manager-repo
      uses: actions/checkout@v2
      with:
        ref: main
        path: ${{ env.CICD_REPO_MGR_DIR }}
    - id: parse-system-def
      name: parse-system-def
      run: |
        SYSTEM_DEFS_FILE=$(ls ${SYSTEM_DEFS_DIR}/${SYSTEM_NAME}.y*)
        REPO_NAMES=$(yq e '[.organization + "/" + .components[].repo]' "${SYSTEM_DEFS_FILE}" -o json)
        echo "REPO_NAMES: ${REPO_NAMES}"
        echo ::set-output name=system-repo-names::$(echo ${REPO_NAMES})
    outputs:
      system-repo-names: ${{ steps.parse-system-def.outputs.system-repo-names }}
      CICD_REPO_MGR_DIR: ${{ env.CICD_REPO_MGR_DIR }}
      CICD_TOKEN: ${{ steps.setup-environment.outputs.secret-token }}
  onboard-system:
    runs-on: build.mdw.nicks.world
    needs: gather-system-info
    env:
      CICD_REPO_MGR_DIR: ${{ needs.gather-system-info.outputs.CICD_REPO_MGR_DIR }}
    strategy:
      matrix:
        system-repo: ${{ fromJSON(needs.gather-system-info.outputs.system-repo-names) }}
    steps:
      - id: setup-environment
        name: setup-environment
        run: |
          set -x
          echo "WORKING_DIR=${GITHUB_WORKSPACE}/${{ matrix.system-repo }}" >> ${GITHUB_ENV}
          set +x
      - id: clone-cicd-manager-repo
        name: clone-cicd-manager-repo
        uses: actions/checkout@v2
        with:
          ref: main
          path: ${{ env.CICD_REPO_MGR_DIR }}
      - id: clone-app-repo
        name: clone-app-repo
        uses: actions/checkout@v2
        with:
          repository: ${{ matrix.system-repo }}
          ref: main
          path: ${{ env.WORKING_DIR }}
          token: ${{ needs.gather-system-info.outputs.CICD_TOKEN }}
      - id: install-github-workflow-directory
        name: install-github-workflow-directory
        run: |
          set -x
          rm -rf ${WORKING_DIR}/.github
          cp -R ${CICD_REPO_MGR_DIR}/.github-app-template ${WORKING_DIR}/.github
          if [[ ! -z "$(git -C ${WORKING_DIR} status --porcelain)" ]]
          then
              git -C ${WORKING_DIR} config user.email ${cicd-team@my-org.com}
              git -C ${WORKING_DIR} config user.name ${GITHUB_ACTOR}
              git -C ${WORKING_DIR} add -A 
              git -C ${WORKING_DIR} commit -am 'installing latest cicd-poc-mgr GitHub Action Workflow(s)'
              git -C ${WORKING_DIR} push
          else
              echo "${{ matrix.system-repo }} is unchanged.  Skipping..."
          fi
          set +x
